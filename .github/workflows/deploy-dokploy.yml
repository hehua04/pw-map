name: Deploy to Dokploy

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches:
      - main

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    environment:
      name: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create Deployment
        uses: chrnorm/deployment-action@v2
        id: deployment
        with:
          token: ${{ secrets.GH_TOKEN }}
          environment: production

      - name: Trigger Dokploy Webhook
        id: dokploy
        run: |
          PAYLOAD=$(
            cat <<'JSON'
          {
            "event": "deploy",
            "repository": "${{ github.repository }}",
            "ref": "${{ github.event.workflow_run.head_branch }}",
            "sha": "${{ github.event.workflow_run.head_sha }}",
            "run_id": "${{ github.event.workflow_run.id }}",
            "run_url": "${{ github.event.workflow_run.html_url }}"
          }
          JSON
          )

          RESPONSE=$(curl -X POST "${{ secrets.DOKPLOY_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" \
            -w "\n%{http_code}" \
            -s)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "Webhook triggered successfully"
            exit 0
          else
            echo "Webhook failed with code $HTTP_CODE"
            exit 1
          fi

      - name: Update Deployment Status - Success
        if: success()
        uses: chrnorm/deployment-status@v2
        with:
          token: ${{ secrets.GH_TOKEN }}
          deployment-id: ${{ steps.deployment.outputs.deployment_id }}
          state: success
          environment-url: https://your-app.example.com

      - name: Update Deployment Status - Failure
        if: failure()
        uses: chrnorm/deployment-status@v2
        with:
          token: ${{ secrets.GH_TOKEN }}
          deployment-id: ${{ steps.deployment.outputs.deployment_id }}
          state: failure
